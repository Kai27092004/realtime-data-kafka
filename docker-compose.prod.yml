version: "3.8"

services:
  # 1. ZOOKEEPER
  zookeeper:
    image: confluentinc/cp-zookeeper:7.3.0
    container_name: zookeeper-prod
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "22181:2181"

  # 2. KAFKA (Internal only - no external access)
  kafka:
    image: confluentinc/cp-kafka:7.3.0
    container_name: kafka-prod
    depends_on:
      - zookeeper
    # ✅ Không expose port 9092 ra ngoài nữa
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      # ✅ Chỉ dùng listener nội bộ, không cần IP Public
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

  # 3. POSTGRESQL DATABASE
  postgres:
    image: postgres:15-alpine
    container_name: postgres-prod
    restart: always
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: producer_logs
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
  # --- THÊM SERVICE REDIS ---
  redis:
    image: redis:alpine
    container_name: redis-prod
    restart: always
    ports:
      - "6379:6379" # Mở port nếu cần debug từ ngoài, không thì bỏ cũng được
  # PRODUCER API
  api-producer:
    build: ./backend/api-gateway-producer
    container_name: api-producer-prod
    restart: always
    ports:
      - "3000:3000" # Giữ lại để test IP nếu cần, hoặc đóng lại cũng được
    environment:
      - PORT=3000
      - KAFKA_BROKER=kafka:29092
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USERNAME=admin
      - DB_PASSWORD=admin
      - DB_DATABASE=producer_logs
      - DB_SYNC=true
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Cập nhật URL nội bộ hoặc public domain đều được
      - CONSUMER_SERVICE_URL=http://consumer-service:3001
      - PRODUCER_SERVICE_URL=http://api-producer:3000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./docker-compose.prod.yml:/app/docker-compose.prod.yml
    depends_on:
      - kafka
      - postgres
      - redis

  # CONSUMER SERVICE
  consumer-service:
    build: ./backend/consumer-service
    restart: always
    # Không cần ports mapping nữa vì Nginx sẽ gọi nội bộ qua mạng Docker
    # Nhưng giữ lại để debug nếu muốn: - "3001:3001"
    environment:
      - PORT=3001
      - KAFKA_BROKER=kafka:29092
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USERNAME=admin
      - DB_PASSWORD=admin
      - DB_DATABASE=consumer_logs
      - DB_SYNC=true
    depends_on:
      - kafka
      - postgres

  # FRONTEND (Đóng vai trò Nginx Server chính)
  frontend:
    build:
      context: ./frontend
      args:
        # ✅ QUAN TRỌNG: Frontend phải biết nó đang chạy ở domain nào
        - VITE_PRODUCER_URL=https://nhanit.id.vn/api
        - VITE_CONSUMER_URL=https://nhanit.id.vn/api
    container_name: frontend-prod
    restart: always
    ports:
      - "80:80" # Cổng chính của Web
      - "443:443"
    volumes:
      # ✅ Mount file nginx.conf vào container frontend
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    depends_on:
      - api-producer
      - consumer-service

  certbot:
    image: certbot/certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
volumes:
  postgres_data:
